# 8장 - url 단축기 설계

### **1 - 1.**  URL 단축기(URL shortening) 설계 

> URL 단축(URL shortening)은 **월드 와이드 웹 상의 긴 URL을 짧게 만들어 주는 기술**이다. 
유명한 서비스로는 BitryURL이 있다.
> 

**URL 단축기를 설계하는 이유와 장점**
기업들과 개인들이 URL 단축 서비스를 활용하는 이유는 온라인 콘텐츠의 공유 및 홍보 전략에 중요한 역할을 담당합니다.

1. **길이 단축**:
    - 가장 명백한 이유는 긴 URL을 짧고 관리하기 쉬운 형태로 줄이기 위함입니다. 
    문자 수 제한이 있는 플랫폼(예: 트위터)에서 유용합니다.
2. **이용 편의성**:
    - 짧은 URL은 사용자가 쉽게 복사하고 붙여넣기 할 수 있으며, 
    텍스트 메시지나 인쇄된 자료에서 사용자가 입력하기에도 더 간편합니다.
3. **추적 가능성**:
    - 단축 URL 서비스는 클릭수, 사용자 위치, 접속한 장치 등의 사용 데이터를 추적하여, 
    웹사이트 운영자가 트래픽을 분석하는 데 도움을 줄 수 있습니다.
4. **브랜딩**:
    - 기업이나 개인은 맞춤형 단축 URL을 사용하여 브랜드 인지도를 높일 수 있습니다. 예를 들어, `brand.link/product` 와 같이 브랜드 이름을 포함한 짧은 URL을 사용할 수 있습니다.
5. **보안 강화**:
    - 단축 서비스는 방문자를 리디렉션하기 전에 원본 URL이 안전한지 검사하여, 악성 사이트로의 접속을 방지합니다.
6. **소셜 미디어 활용 증대**:
    - 짧은 URL은 소셜 미디어 공유에 이상적입니다. 사용자가 긴 URL 대신 짧은 URL을 공유하기 때문에, 메시지가 더 깔끔해 보이고, 메시지의 핵심 내용에 더 집중할 수 있습니다.
7. **마케팅 및 광고 효율성**:
    - 마케팅 캠페인에서는 다양한 플랫폼과 채널을 통해 URL을  배포한 다음. 각 URL의 성과를 측정해야 하는 경우가 많습니다. 단축 URL서비스에서 쉽게 관리하고 분석할 수 있습니다.
8. **메모리 및 데이터 공간 절약**:
    - 짧은 URL은 서버에서 처리할 때 더 적은 저장 공간을 차지하며, 네트워크를 통한 데이터 전송량도 줄일 수 있습니다.
9. **QR 코드 변환 용이성**:
    - 짧은 URL은 QR 코드로 변환할 때 더 작고 단순한 QR 코드를 생성할 수 있어, 스캔이 더 쉽고 빠릅니다.

---

**URL 단축의 단점 / 잠재적 문제점**

1. **불투명성**:
    - 단축된 URL은 사용자가 클릭하기 전까지 최종 목적지를 알 수 없게 만들어, 사용자가 의도하지 않은 위험한 웹사이트로 리디렉션될 가능성이 있습니다.
2. **악용 가능성**:
    - 사용자는 단축 URL의 불투명성으로, 위장된링크로 불법사이트에 방문할 수 있습니다.
3. **서비스의 종속성**:
    - URL 단축 서비스가 중단될 경우, 모든 단축 URL이 작동하지 않게 됩니다.
4. **SEO(검색 엔진 최적화) 영향**:
    - 일부 검색 엔진은 단축 URL을 원본 URL보다 낮은 가치로 취급하지 않을 수 있습니다.
5. **추적 및 개인정보 보호**:
    - 단축 URL 서비스들이 클릭 데이터를 추적하므로 사용자의 프라이버시 침해 우려가 있습니다.
6. **성능 지연**:
    - 단축 URL을 통한 추가 리디렉션은 웹 페이지 로딩 시간을 증가시킵니다.
7. **신뢰도 문제**:
    - 많은 이메일 서비스나 메시징 플랫폼은  단축 URL을 필터링하기 때문에, 스팸으로 간주될 수 있습니다.
8. **관리 및 유지보수 그리고 비용**:
    - 단축 URL을 생성하고 관리하는 것은 추가적인 관리 작업을 요구하며, 이는 시간과 자원이 들어가는 일입니다.

이런 장/단점을 갖추고 있어서 꽤나 규모가 큰 기업임에도 단축서비스를 이용하지 않는 서비스도 존재한다.

### 2 **- 1.  문제 이해 및 설계 범위 확정**

> 책에 나온 **전체적인 요구사항은 아래와 같다.**
> 
> 1. 매일 1억개의 단축 URL을 생성할 수 있어야 한다.
> 2. 단축 URL은 짧으면 짧을수록 좋다.
> 3. 생성된 단축 URL은 삭제하거나 갱신할 수 없다.
> 4. 높은 가용성(HA, High Availability)과 규모 확장성(Scalability), 장애 감내(FT, Fault Tolerance)가 요구된다.

*장애 감내 혹은 내결함성이란 ?
시스템을 구성하는 하나 이상의 구성요소에 장애가 발생해도 시스템이 중단없이 계속 작동할 수 있는 성질을 의미한다.

- HA : 
서비스 중단이 허용되는 최소의 시간이 존재한다. 
예를 들어 가용성이 99.99999999999999%인 시스템은 연간 5분의 다운타임을 허용한다.
- FT : 
서비스 중단이 전혀 없이 동작해야한다. 비유하자면 스페어 타이어가 있는 자동차는 HA이다. 타이어는 펑크가 날 수 있지만, 빠른 시간내에 타이어를 교체할 수 있다. 
반면, 엔진이 2개인 쌍발 비행기는 FT이다. 엔진 하나가 고장나도 다른 엔진으로 계속 비행할 수 있다.

---

**계략적 추정**

- 쓰기 연산: 매일 1억 개의 단축 URL 생성
- 초당 쓰기 연산: 1억(100million)/24/3600 = 1160
- 읽기 연산: 읽기 연산과 쓰기 연산 비율은 10:1이다. 그 경우 읽기 연산은 초당 11,600회 발생한다. (1160*10 = 11,600)
- URL 단축 서비스를 10년간 운영한다고 가정하면 1억*365*10 = 3650억 개의 레코드를 보관해야 한다.
- 축약 전 URL의 평균 길이는 100이라고 가정한다.
- 따라서, 10년 동안 필요한 저장 용량은 3650억 * 100바이트 = 36.5 TB이다.

---

**계산방법** 

1. **초당 쓰기 연산 (Write Operations per Second, WOPS)**:
   
  <img width="460" alt="s-0" src="https://github.com/organization-for-study/study-system-design-interview/assets/97773895/de7768a7-5bb7-411f-9aac-c05a80d24185">

- 시스템이 하루 동안 처리해야 할 작업량을 일일 초로 나누어, 평균적인 초당 쓰기 요청량을 산출합니다. 하루는 24시간, 1시간은 3600초, 즉, 하루는 총 86,400초입니다. 
따라서 하루에 1억 개의 URL을 생성해야 한다면, 시스템은 초당 약 1160개의 쓰기 작업을 수행해야 합니다. 시스템이 감당해야 할 최소 쓰기 부하를 나타내며, 피크 타임의 부하는 이보다 클 수 있습니다.

3. **초당 읽기 연산 (Read Operations per Second, ROPS)**:
   
  <img width="456" alt="s-1" src="https://github.com/organization-for-study/study-system-design-interview/assets/97773895/6394688c-3ba8-467a-aa2e-32fc041b76e8">

- 여기서 읽기 연산은 보통 쓰기 연산보다 훨씬 빈번하게 발생합니다. 
단축 URL 서비스의 경우, 사용자는 생성된 단축 URL을 사용해 원본 페이지로 리디렉션을 요청하는 읽기 작업을 더 자주 수행합니다. 
읽기와 쓰기 비율이 10:1이라고 가정할 때, 이는 시스템이 쓰기 작업보다 10배 더 많은 읽기 작업을 처리해야 함을 의미합니다. 따라서 이 공식은 시스템이 초당 처리해야 할 읽기 요청량을 산출합니다.

5. **총 레코드 수 (Total Records over 10 Years)**:
   
   <img width="702" alt="s-2" src="https://github.com/organization-for-study/study-system-design-interview/assets/97773895/3ce0d539-4266-4009-9484-ae0bcbddc042">

- 이 계산은 시스템이 장기간 운영되는 동안 축적될 데이터의 총량을 예측하기 위한 것입니다. 
10년간 매일 1억 개의 단축 URL을 생성한다고 가정하면, 10년 후에 시스템이 처리해야 할 총 레코드 수는 약 3650억 개가 됩니다. 
데이터베이스 설계, 저장소 용량 계획 및 데이터 유지 관리 전략을 결정하는 데 중요한 지표입니다.

7. **필요한 저장 용량 (Total Storage Requirement over 10 Years)**:
   
    <img width="702" alt="s-3" src="https://github.com/organization-for-study/study-system-design-interview/assets/97773895/7c5fcbb0-43d1-4815-b5bd-667f45f44a01">
   
- 시스템이 10년 동안 축적해야 하는 데이터의 양을 계산할 때, 각 URL이 평균적으로 얼마만큼의 공간을 차지하는지 고려해야 합니다.  여기서는 각 URL을 100바이트로 가정하여 계산합니다. 
실제로는 URL이 이보다 길거나 짧을 수 있지만, 평균치를 사용하여 총 저장 용량을 추정합니다. 이를 통해 시스템이 처리해야 할 데이터의 총량과 필요한 저장 공간을 예측할 수 있습니다.

---

### 3 **- 1.  API 엔드포인트**

> URL 단축 서비스를 운영하기 위해서는 **최소한 이 두 가지 엔드포인트**가 필요합니다.
두 개의 엔드포인트는 서로 다른 작업을 수행합니다.
> 
1. **URL 단축 생성 (Shortening a URL)**:
    - **엔드포인트 예시**: 
    `POST` /api/v1/data/shorten
    - **기능**: 
    사용자가 긴 URL을 단축서비스에 전송합니다. 
    해당 요청을 받은 서비스는 짧은 URL을 생성한 뒤 응답으로 반환합니다. 
    `POST` 인 이유는 데이터를 생성하거나 변경하는 '쓰기' 작업에 해당해서 그렇습니다.
2. **URL 리디렉션 (Redirecting to the original URL)**:
    - **엔드포인트 예시**: 
    `GET` /api/v1/shortUrl
    - **기능**: 
    사용자가 짧은 URL을 요청후, 서비스는 원본 긴 URL을 매핑합니다.
    그리고 사용자의 브라우저를 해당 원본 URL로 리디렉션합니다. 
    이 작업은 데이터를 조회하는 '읽기' 작업에 해당합니다.

**예시 :**
사용자가 짧은 URL에 액세스하면, 서비스는 원래의 긴 URL로 사용자를 리디렉션해야 합니다. 
짧은 URL 링크(예: `http://sho.rt/example`)를 클릭하면, URL 단축 서비스는 해당 요청을 받습니다.
단축서비스는 짧은 URL이 원본의 긴 URL(예: `http://www.example.com/very/long/url/path`)에 
해당하는 것을 찾아서, 사용자의 브라우저를 그 긴 URL로 리디렉션합니다.

### 3 **- 2.  왜 두개인가?**

> RESTful API의 설계 원칙 중 하나인 "관심사의 분리"를 따르기 때문입니다.

*관심사의 분리 : 
RESTful API에서 관심사의 분리(Separation of Concerns, SoC)는 각 API 엔드포인트가 한 가지 주요 기능만을 수행하도록 설계하는 것을 의미
> 

따라서, URL 단축 서비스를 운영하기 위해서는 최소한 이 두 가지 엔드포인트가 필요합니다. 
하나는 URL을 단축하는 역할을 하고, 다른 하나는 단축된 URL을 원래의 긴 URL로 리디렉션하는 역할을 합니다.

<img width="584" alt="Untitled (43)" src="https://github.com/organization-for-study/study-system-design-interview/assets/97773895/3b293501-cd52-4b0b-bc82-d33707749937">


### 3 **- 3.  URL 리디렉션**

> URL 리디렉션은 사용자가 특정 웹 주소URL로 브라우저를 통해 접근했을 때, 
해당 주소가 다른 주소로 사용자를 자동으로 안내하는 웹 서버의 동작을 말합니다.
HTTP에서 Redirection에 관한 status, header를 제공합니다.
> 

- **301 Moved Permanently**:
    - 영구적인 URL 리디렉션입니다.
    - 검색 엔진은 이를 인식하여 링크 주스(link juice)를 새로운 URL로 이전합니다.
    - 브라우저는 이 정보를 캐시합니다.
    - 캐시된 데이터로 인해 동일한 주소에 대한 후속 요청을 새 주소로 자동 리디렉션합니다.
    - 캐시 데이터가있으니 서버 부하를 줄이는 데 도움이 될 수 있습니다.
    - 일반적으로 영구적인 주소 변경이 있을 때 사용됩니다.
- **302 Found**:
    - 일시적인 URL 리디렉션을 나타냅니다.
    - 검색 엔진은 URL의 변경을 영구적이지 않다고 간주합니다.
    - 원래 URL에 대한 링크의 가치와 권위를 유지합니다.
    - 브라우저는 캐시를 저장하지 않습니다.
    - 모든 요청은 매번 단축 URL 서버를 통해 원래 URL로 리디렉션됩니다.
    - 트래픽 분석이 중요할 때 유용합니다.
    

### 3 **- 4.  301, 302** 언제사용할까?

> 일반적으로, URL 변경이 일시적이라면 302를, 영구적이라면 301을 사용합니다. 
사용자의 의도와 상황에 맞게 적절한 리디렉션을 사용하는 것이 중요합니다.
> 

**301 Moved Permanently 영구적 리디렉션 언제사용할까?**

- **URL이 영구적으로 변경되었을 때**:
    - 웹페이지가 새 URL로 옮겨진 경우나 사이트 구조가 변경되어 
    기존의 URL을 더 이상 사용하지 않을 때 사용합니다.
- **도메인 이전 시**:
    - 웹사이트가 새 도메인으로 이전하는 경우
    - 기존 도메인에서 새 도메인으로 사용자와 검색 엔진을 안내하기 위해 301 리디렉션을 사용합니다.
- **URL 통합 시**:
    - 여러 URL이 같은 콘텐츠를 가리킬 때, 주로 검색 엔진 최적화(SEO) 목적으로 한 주소로 통합합니다.
- **장점**
    - 검색 엔진은 301 리디렉션을 통해 페이지의 원래 콘텐츠가 새 URL로 옮겨졌음을 인식합니다.
    검색 결과에서 오래된 URL 대신 새 URL을 표시합니다.
    - 링크 주스(link juice) 또는 페이지 권위가 새 URL로 이전됩니다.
- **주의할 점**
    - 사용자의 브라우저는 301 리디렉션을 캐시하므로, URL 변경을 되돌리기 어렵습니다.

**302 Found 임시적 리디렉션 제사용할까?**

- **임시적인 콘텐츠 변경 시**:
    - 원래 페이지를 업데이트 중일 때, 임시 페이지로 사용자를 안내할 필요가 있을 때 사용합니다.
- **A/B 테스팅 시**:
    - 사용자의 반응을 테스트하기 위해 동일한 URL에 대해 다른 버전의 페이지를 보여줄 때 사용합니다.
- **프로모션이나 이벤트 시**:
    - 특정 기간 동안만 진행되는 프로모션 페이지로 리디렉션할 때 사용합니다.
- **장점**
    - 임시적인 변경이므로, 원래 URL의 SEO 가치를 유지합니다.
    - 브라우저는 302 리디렉션을 캐시하지 않기 때문에, 변경을 쉽게 되돌릴 수 있습니다.
- **주의할 점**
    - 302 리디렉션이 장기간 사용될 경우, 검색 엔진이 영구적인 리디렉션으로 오해할 수 있으므로 주의가 필요합니다.

### 3 **- 5. URL 단축과 해시값 - 해시함수**

> URL을 단축시킬때 해시값을 사용한다.
www.tinyurl.com/[hashValue] 에서  [hashValue]는 원본 URL을 대표하는 고유한 해시값입니다.
> 

<img width="197" alt="Untitled (44)" src="https://github.com/organization-for-study/study-system-design-interview/assets/97773895/c37d4762-40c3-42c8-a09b-8c367738dc07">

- **해시값 :**
    - 해시값은 원본 데이터를 대표하는 고정 길이의 값입니다.
    - 해시 함수를 통해 계산됩니다.
    - 어떤 길이의 데이터든지 간에 고정된 크기의 해시값으로 매핑하는 역할을합니다.
    - 주로 데이터 관리 및 검색 알고리즘에서 사용됩니다.
        - **데이터 저장**: 
        해시 테이블 같은 자료 구조에서는 해시값을 사용하여 데이터를 빠르게 저장하고 검색할 수 있습니다.
        - **보안**: 
        암호학에서 해시 함수는 패스워드 저장, 메시지의 무결성 검사, 디지털 서명 등에 사용됩니다.
        - **데이터 무결성**: 
        파일이나 메시지가 전송 과정에서 변경되지 않았는지 확인하기 위해 사용됩니다.

---

- **URL 단축 서비스에서 해시 함수의 역할과 중요한 특성을 갖는가 :**
    - **고유성**:
        - 각 원본 URL이 서로 다른 해시값을 가져야 합니다.
        - 즉, 각 URL이 고유한 단축 URL을 가질 수 있도록 합니다.
        - 해시 함수는 충돌 가능성을 최소화하는 방식으로 설계되어야 합니다.
    - **역추적 가능성**:
        - URL 단축 서비스에서는 해시값을 이용해 원본 URL을 역추적할 수 있어야 합니다.
        - 이를 위해 서비스 제공자는 해시값과 원본 URL의 매핑을 데이터베이스에 저장합니다.
        - 사용자가 단축 URL을 사용할 때 해당 원본 URL로 리디렉션될 수 있도록 합니다.

### 4 **- 1. 상세설계**

### 초기 고려 사항:

- **목적**: 긴 URL을 더 짧고 관리하기 쉬운 버전으로 변환하여 공유 및 사용이 용이하게 만듭니다.
- **고려사항:** 각 URL에 대해 영구적이고 충돌에 강한 고유 식별자를 생성합니다.
- **요구사항 :** 단축 URL은 알파벳과 숫자로만 구성되어야합니다.
0-9, a-z, A-Z → 62개의 문자를 사용할 수 있습니다.

### 핵심 구성요소:

1. **데이터 저장**:
    - 초기 설계에는 해시테이블을 사용해도됩니다.
    하지만 고비용 저용량에의해 실제서비스에선 RDB를 권합니다.
    - 원본 URL과 단축 URL 간의 매핑을 저장하기 위해 관계형 데이터베이스를 사용합니다.
    - `id`, `shortURL`, `longURL` 필드가 있는 테이블을 사용합니다.
2. **해시 함수**:
    - 해시 함수는 원본 URL을 짧은 코드(shortURL)로 변환합니다.
    - 이 코드의 길이는 `62^n` 공식에 의해 결정됩니다.
    n은 문자의 수입니다.
    n의 최소값은 `62^n >= 3650억` 불평등을 만족해야 합니다.
3. **해시 함수 전략**:
    - CRC32, MD5, SHA-1과 같은 잘 알려진 해시 함수를 사용하고, 충돌을 처리하기 위해 사전 정의된 문자열을 추가하여 재해싱합니다.
    - 고유 ID를 짧은 URL로 변환하기 위해 base-62 인코딩을 구현합니다.

### 설계 프로세스 흐름:

1. **입력**: 사용자로부터 긴 URL을 받습니다.
2. **확인**: 데이터베이스에 URL이 이미 있는지 확인합니다.
3. **기존 항목**: 존재하면 관련된 단축 URL을 반환합니다.
4. **새 항목**: 존재하지 않는다면 고유 ID를 생성합니다.
5. **ID 변환**: 고유 ID에 base-62 인코딩을 적용하여 단축 URL을 생성합니다.
6. **저장**: 원본 URL, 단축 URL, 그리고 고유 ID를 데이터베이스에 저장합니다.
7. **출력**: 단축 URL을 사용자에게 제공합니다.

### 추가 기능 및 고려사항:

- **리디렉션**: 단축 URL에서 원본 URL로의 HTTP 리디렉션을 구현합니다.
- **로드 밸런싱**: 여러 서버에 요청을 분산하여 높은 가용성과 성능을 보장하기 위해 로드 밸런서를 사용합니다.
- **캐싱**: 인기 있는 URL을 캐시하여 응답 시간을 개선합니다.
- **요청 제한**: IP 주소 또는 API 키를 기반으로 한 요청 제한을 구현하여 서비스 남용을 방지합니다.

### 보안 및 확장성:

- **암호화**: 민감한 데이터를 암호화하여 저장하고 모든 통신에 HTTPS를 사용합니다.
- **확장성**: 데이터베이스 샤딩 및 상태 비저장 웹 서버의 수평 확장과 같은 기술을 사용하여 부하 증가에 대응할 수 있도록 시스템을 설계합니다.

### 분석:

- **데이터 수집**: URL 사용 현황을 추적하여 인기도와 사용자 행동에 대한 통찰력을 얻습니다.
- **보고서**: 단축 URL 사용의 빈도와 패턴에 대한 분석을 제공합니다.

### 최종 생각:

- **API**: 개발자들이
