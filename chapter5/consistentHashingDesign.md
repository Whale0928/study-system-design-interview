## 5장 안정 해시 설계

## 1. 해시 키 재배치 문제

```
serverIndex = hash(key) % N(N은 서버의 개수이다)
```

- serverIndex는 해시를 서버의 개수로 나눈 나머지 값.
- 적용하려는 서버 또는 데이터의 갯수가 고정되어 있을 경우 문제가 없지만 대상에 추가 또는 삭제 등의 변동이 있는 경우 대부분의 해시 대상이 재분배 되기 때문에 확장성(scalability)에 취약함.
  
![스크린샷 2023-12-18 오후 10 34 33](https://github.com/organization-for-study/study-system-design-interview/assets/126097518/1236b723-b583-4dbd-9a04-67034f88e1d0) ![스크린샷 2023-12-18 오후 9 30 20](https://github.com/organization-for-study/study-system-design-interview/assets/126097518/e0cb5390-1350-48f9-8767-77e157466b5a)

- 나머지 연산을 적용해서 서버 인덱스를 구한 표의 내용.
- 서버 1에 장애가 나는 경우, 위의 N(서버의 개수)을 기반으로 키가 재분배됨.

       ⇒ 캐시 클라이언트가 엉뚱한 서버에 접속되는 대규모 캐시미스(cache miss) 발생.

## 2. 안정 해시

### 2-1. 안정 해시(Consistent Hashing)란?

일반적으로 요청 또는 데이터를 서버에 균등하게 나누기 위해 일반적으로 사용되는 기술.

- 안정 해시는 해시 테이블 크기가 조정될 때 평균적으로 key/n(서버의 개수)의 키만 재배치하도록 하는 해시기술.
- 해시 공간의 양쪽을 구부려 접으면 해시 링이 만들어진다.

![스크린샷 2023-12-18 오후 10 48 55](https://github.com/organization-for-study/study-system-design-interview/assets/126097518/23ee92f2-1d07-40e5-92a5-a3e803088bb8)

- **균등한 데이터 분산**
- **노드 추가 및 제거의 용이성**
- **분산 데이터베이스에서의 활용**

### 2-2. 안정 해시 문제점

- 균등 분포 해시 함수를 사용
- 시계 방향 첫 번째의 서버를 지정하는 것

균등 분포 해시 함수를 사용해도 해시 파티션(partition) (위 그림의 링 위의 서버 사이의 간격) 의 크기를 균등하게 유지하는게 불가능 하다는 것과 이로 인해 키가 균등하게 분포되기 어렵다

위와 같은 문제를 해결하기 위해 `가상노드(Virtual Node)` or `복제(Replica)`라 불리는 기법을 사용.

### 2-3. 안정 해시의 가상노드

![스크린샷 2023-12-18 오후 11 12 32](https://github.com/organization-for-study/study-system-design-interview/assets/126097518/f2c94546-b069-47d1-890c-a456b61ec535) ![스크린샷 2023-12-18 오후 11 13 23](https://github.com/organization-for-study/study-system-design-interview/assets/126097518/6d1b4484-dcc8-4e76-bee7-e2cd3c585bb9)

- 하나의 서버는 링 위에서 여러 개의 가상 노드를 가지게 됨.
- 안정 해시는 시계방향으로 링을 탐색 후 첫번째 만나는 서버를 대상으로 키가 저장되므로, 가상 노드가 없는 좌측 그림의 구조와 달리 가상 노드가 많을 수록 키의 균등 분포에 유리함.

⇒ **가상노드의 개수를 더 늘리면 표준편차는 작아지게 되지만 키의 분포는 고르게 분포되어 데이터를 저장할 공간은 더 많이 필요하게 될 것. 상황에 맞는 타협적 결정 필요.**

### 2-4. 사례

1. **Cassandra** 같은 대규모 데이터를 다루는 NoSQL 데이터베이스는 안정해시를 이용해 데이터를 여러 노드에 분산시킴. 
2. **Memcached**: 분산 캐시 시스템에서도 안정해시가 활용됨. 캐시 서버의 추가나 제거가 있을 때 전체 캐시를 재분배하는 것을 최소화하여 효율성을 높임. 
    
      (Memcached는 데이터베이스나 API 등의 외부 소스로부터 가져온 데이터를 메모리에 캐시하여 빠르게 제공할 수 있도록 도와주는 오픈 소스 소프트웨어)
    
3. **로드 밸런싱**: 요청을 여러 서버에 균일하게 분산시킬 때 안정 해시가 사용됨.
4.  **Amazon의 DynamoDB**: 파티션 키를 효율적으로 관리하고 데이터를 분산 저장하는 데 사용됨.
5. **디스코드:** 대규모 사용자, 서버를 처리하기 위해 서버를 여러 노드에 분산하여 관리할 때 사용.?
